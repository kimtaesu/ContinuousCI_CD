# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

import './VersionFastFile'

default_platform(:ios)

PRODUCTION_CONFIG_PATH = 'fastlane/BuildConfiguration/Production.xcconfig'
VERSION_CONFIG_PATH = 'fastlane/BuildConfiguration/Common/Versions.xcconfig'

lane_context[SharedValues::BUILD_NUMBER] = get_xcconfig_value(
  path: VERSION_CONFIG_PATH,
  name: 'LONG_BUNDLE_VERSION'
)

lane_context[SharedValues::VERSION_NUMBER] = get_xcconfig_value(
  path: VERSION_CONFIG_PATH,
  name: 'BUNDLE_VERSION'
) 

lane_context['app_name'] = get_xcconfig_value(
  path: PRODUCTION_CONFIG_PATH,
  name: 'PRODUCT_NAME'
) 


platform :ios do  
  desc "Push a new release build to the App Store"
  lane :release do | options |
    # precheck
    # snapshot
    # puts "determine version_number: [#{lane_context[SharedValues::VERSION_NUMBER]}] build_number: [#{lane_context[SharedValues::BUILD_NUMBER]}]"

    # produce(
    #   app_name:lane_context['app_name'],
    #   enable_services: {
    #     push_notification: "on"
    #   }
    # )
  
    match(type: 'appstore', readonly: true)
    build_ios_app(
      scheme: "Production",
      clean: true,
      output_directory: "fastlane/build", 
      output_name: "#{lane_context['app_name']}.ipa"
    )
    deliver(
      force:true,
      ipa:"fastlane/build/#{lane_context['app_name']}.ipa",
      app_version:lane_context[SharedValues::VERSION_NUMBER]
    )
  end
end

